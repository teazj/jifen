<?php/*---------------------------权限分配用户信息管理Action---------------------------*/class Rbac_userAction extends CommonAction{	/*--------封装搜素条件-----------*/	public function _filter(&$map){		//搜索条件有值则做封装		if(!empty($_REQUEST['keyword'])){			$where['username']  = array('like', "%{$_REQUEST['keyword']}%");			$where['name']  = array('like',"%{$_REQUEST['keyword']}%");			$where['_logic'] = 'or';			$map['_complex'] = $where;		}		//判断是否有角色信息搜索		if(!empty($_REQUEST['roleid'])){			$list = M("Rbac_user_role")->field("uid")->where("rid={$_REQUEST['roleid']}")->select();			if($list && count($list)>0){				$uid=array();				foreach($list as $v){					$uid[]=$v['uid'];				}				//封装uid的条件				$map["id"]=array("in",$uid);			}		}	}		/*----------追加一个补充用户角色的方法----------*/	public function _tigger_list(&$list){		$mod = M();		//遍历查询的用户信息，并追加角色信息		foreach($list as &$v){			//根据当前用户信息获取对应的角色名			$res = $mod->query("select name from ff_rbac_role r,ff_rbac_user_role ur where r.id=ur.rid and ur.uid={$v['id']}");			$roles=array();			if(!empty($res)){				foreach($res as $ob){					$roles[]=$ob['name'];				}			}			//将获取的角色名放到用户信息中			$v['roles']=implode(",",$roles);		}	}		/*---------------------显示首页---------------------*/	public function index(){		//获取所有角色信息		$rolelist = M("Rbac_role")->field("id,name")->select();		$this->assign("rolelist",$rolelist); //封装到模板		parent::index();	}		/*-----------重写添加方法，做一些额外处理--------------*/	public function insert(){		//判断密码和重复密码是否一致		if($_POST['userpass']!=$_POST['repass']){			$this->error("密码和重复密码不一致！");			return;		}		//对密码加密		$_POST['userpass'] = md5($_POST['userpass']);		//调用父类的添加方法执行添加操作		parent::insert();	}		/*---------------浏览当前用户的角色信息-------------*/	public function rolelist(){		//1. 获取当前用户信息		$uid = $_GET['uid'];		$user = M("Rbac_user")->find($uid); 		$this->assign("user",$user);		//2. 获取所有角色信息		$list = M("Rbac_role")->select();		$this->assign("list",$list);		//3. 获取当前用户的角色信息		$rolelist = M("Rbac_user_role")->where("uid={$uid}")->select();		//对获取的结果进行处理		$myrole=array();		foreach($rolelist as $v){			$myrole[]=$v['rid'];		}		$this->assign("myrole",$myrole);		//4.显示模版		$this->display("rolelist");	}		/*-----------执行角色信息的保存-----------*/	public function saverole(){		//1.获取被操作的用户信息		$uid = $_POST['uid'];		//2.删除当前用户的所有角色信息		$m = M("Rbac_user_role");		$m->where("uid={$uid}")->delete();		//3.将当前选择的角色信息添加上去		if(!empty($_POST['rid'])){			foreach($_POST['rid'] as $rid){				$data['rid']=$rid;				$data['uid']=$uid;				$m->add($data);			}		}		$this->success("修改成功！");	}	}