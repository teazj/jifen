<?php/*---------------------------签证地区类别管理Action---------------------------*/class RzcategoryAction extends CommonAction{		/*--------封装搜素条件-----------*/	public function _filter(&$map){		//搜索条件有值则做封装		if(!empty($_REQUEST['keyword'])){			$where['name']  = array('like',"%{$_REQUEST['keyword']}%");			$where['sort']  = $_REQUEST['keyword'];			$where['_logic'] = 'or';			$map['_complex'] = $where;		}	}		/*-----------重写显示首页方法，做排序处理--------------*/	public function index() {		$_REQUEST['_order']="sort,id";		$_REQUEST['_sort']="asc";		parent::index();	}		/*-----------重写添加方法，做一些额外处理--------------*/	public function insert() {		$_POST['pid']=$_POST['pid']?$_POST['pid']:0;		$_POST['path']=$_POST['path']?$_POST['path']:"0,";		$_POST['sort']=$_POST['sort']?$_POST['sort']:99;		$_POST['rank']=$_POST['rank']?$_POST['rank']:1;		parent::insert();	}	/*--------------添加主类别------------------*/	public function addmain(){		$model=M("Rzcategory");		$type=$model->where("pid=0")->select();		$this->assign("sort",$type[count($type)-1]['sort']+1);		$this->display("addmain");		}	/*--------------添加子类别------------------*/	public function addsub(){		$model=M("Rzcategory");		$type=$model->where("id={$_GET['id']}")->find();		if($type['rank']==2){			$this->error(L('已是具体使馆名!'));			exit();		}else{			$piny=array('A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z');			$this->assign("piny",$piny);			$this->assign("pid",$type['id']);			$this->assign("path",$type['path'].$type['id'].",");			$this->assign("sort",$type['sort']);			$this->assign("rank",$type['rank']+1);			$this->display("addsub");		}	}		public function edit() {		$model=M("Rzcategory");		$type=$model->where("id={$_GET['id']}")->find();		if($type['rank']==1){			$this->error(L('顶级类别不可修改!'));			exit();		}else{			$piny=array('A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z');			$this->assign("piny",$piny);			parent::edit();		}	}	/*--------------ajax显示签证地区类别--------------------*/	public function showtype(){		$model=M("Rzcategory");		$result=$model->field("id,name")->where("pid={$_GET['id']}")->select();		echo json_encode($result);	}	}