<?php/*---------------------------商品管理Action---------------------------*/class GoodsAction extends CommonAction{	/*--------封装搜素条件-----------*/	public function _filter(&$map){		//搜索条件有值则做封装		if(!empty($_REQUEST['keyword'])){			$where['name']  = array('like', "%{$_REQUEST['keyword']}%");			$where['_logic'] = 'or';			$map['_complex'] = $where;		}		//状态为-2时，表示默认没选择，为其他值表示已选择		if(!empty($_REQUEST['status']) && $_REQUEST['status']!="-2"){			$map['status']=$_REQUEST['status'];		//解除封装条件		}else{			unset($map['status']);		}		//通过父类查子类商品		if(!empty($_REQUEST['tid']) ){			$model=M("Goods_type");			//获取子类别的id号			$typelist=$model->where("path like '%,{$_REQUEST['tid']},%'")->field("id")->select();			//把找到的二维数组置换成一维			$tidlist=array();			foreach($typelist as $v){				$tidlist[]=$v['id'];			}			//封装成sql的in条件			$map['tid']=array("in",implode(",",$tidlist));		//解除封装条件		}else{			unset($map['tid']);		}	}		/*----------------重写显示首页--------------------------*/	public function index(){		//商品分类的名称转换		$model=	M("Goods_type");		$typecount=$model->field("id,name")->select();		//获取所有类别		$this->assign("typelist",R("Goods_detail/typelist"));		//获取所有1级类别		$maintype=$model->where("rank=1")->field("id,name")->order("sort asc")->select();		$this->assign("maintype",$maintype);		//调用父类方法		parent::index();	}		/*------------------重写执行删除操作，多表删除---------------------------*/	public function delete(){		//商品详情删除		$model = M("Goods_detail");		if (!empty($model)) {			//主键和id号			$pk = $model->getPk();			$id = $_REQUEST[$pk];			if (isset($id)) {					$condition = array($pk => array('in', explode(',', $id)));				if (false !== $model->where($condition)->delete()) {					parent::delete();				} else {					$this->error(L('删除失败'));				}			} else {				$this->error('非法操作');			}		}	}		/*----------显示编辑状态页面-------------*/	public function editstatus(){		$this->edit("editstatus");	}		/*----------显示位置状态页面-------------*/	public function editlocation(){		$this->edit("editlocation");	}}