<?php/*---------------------------公共信息处理action---------------------------*/class PublicAction extends Action{		/*------------------加载登录页面-------------------*/	public function login(){		$this->display("login");	}		/*-------------------执行登录验证方法---------------*/	public function checkLogin(){		//验证验证码	 	if($_SESSION["verify"]!=md5($_POST['code'])){			$this->assign("errorinfo","验证码错误！");			$this->display("login");			exit();		}		//根据登录账号获取当前用户信息		$authInfo = M("Rbac_user")->where("username = '{$_POST['name']}'")->find();				if($authInfo){			//判断密码			if($authInfo['userpass']===md5($_POST['password'])){				//登录成功				//将当前用户信息存储到session中				$_SESSION[C('USER_AUTH_KEY')]=$authInfo;								//2. 根据当前用户id号获取对应的节点信息				$list = M()->query("select n.mname,n.aname from ff_rbac_user_role ur,ff_rbac_role_node rn,ff_rbac_node n where ur.rid=rn.rid and rn.nid=n.id and ur.uid={$authInfo['id']}");				//dump($list);				//给所有用户默认浏览主页的权限				$nodelist = array("index"=>array("index"));				//遍历并封装节点列表				foreach($list as $v){					$nodelist[$v['mname']][] = $v['aname'];					if($v['aname']=="edit"){	//编辑的两个操作绑定分配一个						$nodelist[$v['mname']][]="update";					}					if($v['aname']=="add"){		//添加的两个操作绑定分配一个						$nodelist[$v['mname']][]="insert";					}				}				//用户拥有的所有操作存到session中				$_SESSION[C('USER_AUTH_KEY')]["nodelist"]=$nodelist;								//跳转首页				$this->redirect('Index/index');							}else{				$this->assign("errorinfo",'登录密码错误！');				$this->display("login");				exit();			}		}else{			$this->assign("errorinfo",'帐号不存在或已禁用！');			$this->display("login");			exit();		}			}		/*-------------执行退出操作方法----------------*/	public function logout(){		unset($_SESSION[C('USER_AUTH_KEY')]);		$this->display("login");	}		/*----------------加载验证码------------------*/	public function verify(){		import('ORG.Util.Image');		Image::buildImageVerify();	}}